{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - YouTube Narration Generator{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
<style>
    .dashboard-header { background-color: #f8f9fa; padding: 20px 0; margin-bottom: 30px; }
    .card { box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); transition: all 0.3s; }
    .card:hover { transform: translateY(-5px); }
    .btn-icon { margin-right: 5px; }
    .filter-section { background-color: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1); margin-bottom: 30px; }
    .filter-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; }
    .filter-form .form-group { margin-bottom: 15px; }
    .filter-form label { font-weight: bold; }
    .filter-form .btn-primary { margin-top: 10px; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="container">
        <h1 class="mb-4">Project Dashboard</h1>
        <div class="row">
            <div class="col-md-3 mb-3">
                <a href="{% url 'create_narration' %}" class="btn btn-primary btn-block">
                    <i class="fas fa-plus btn-icon"></i>Create from YouTube
                </a>
            </div>
            <div class="col-md-3 mb-3">
                <a href="{% url 'create_custom_narration' %}" class="btn btn-success btn-block">
                    <i class="fas fa-pen btn-icon"></i>Create Custom Script
                </a>
            </div>
            <div class="col-md-3 mb-3">
                <a href="{% url 'bulk_create_projects' %}" class="btn btn-info btn-block">
                    <i class="fas fa-file-csv btn-icon"></i>Bulk Create from CSV
                </a>
            </div>
            <div class="col-md-3 mb-3">
                <a href="{% url 'generate_videos_for_all_projects' %}" class="btn btn-warning btn-block">
                    <i class="fas fa-film btn-icon"></i>Generate All Videos
                </a>
            </div>
            <div class="col-md-3 mb-3">
                <a href="{% url 'generate_csv' %}" class="btn btn-secondary btn-block">
                    <i class="fas fa-file-csv btn-icon"></i>Generate CSV for Unpublished Projects
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="filter-section">
        <h3 class="filter-title">Filter Projects</h3>
        <form method="get" class="filter-form">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="search">Search</label>
                        <input type="text" name="search" id="search" class="form-control" placeholder="Search projects" value="{{ request.GET.search }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select name="status" id="status" class="form-control">
                            <option value="">All Statuses</option>
                            <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="tag">Tag</label>
                        <select name="tag" id="tag" class="form-control">
                            <option value="">All Tags</option>
                            <option value="finance" {% if request.GET.tag == 'finance' %}selected{% endif %}>Finance</option>
                            <!-- Add more tag options as needed -->
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="has_youtube_details">YouTube Details</label>
                        <select name="has_youtube_details" id="has_youtube_details" class="form-control">
                            <option value="">All</option>
                            <option value="yes" {% if request.GET.has_youtube_details == 'yes' %}selected{% endif %}>Created</option>
                            <option value="no" {% if request.GET.has_youtube_details == 'no' %}selected{% endif %}>Not Created</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="has_audio">Audio</label>
                        <select name="has_audio" id="has_audio" class="form-control">
                            <option value="">All</option>
                            <option value="yes" {% if request.GET.has_audio == 'yes' %}selected{% endif %}>Created</option>
                            <option value="no" {% if request.GET.has_audio == 'no' %}selected{% endif %}>Not Created</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="has_image">Image</label>
                        <select name="has_image" id="has_image" class="form-control">
                            <option value="">All</option>
                            <option value="yes" {% if request.GET.has_image == 'yes' %}selected{% endif %}>Created</option>
                            <option value="no" {% if request.GET.has_image == 'no' %}selected{% endif %}>Not Created</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="has_final_video">Final Video</label>
                        <select name="has_final_video" id="has_final_video" class="form-control">
                            <option value="">All</option>
                            <option value="yes" {% if request.GET.has_final_video == 'yes' %}selected{% endif %}>Created</option>
                            <option value="no" {% if request.GET.has_final_video == 'no' %}selected{% endif %}>Not Created</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="is_published">Published</label>
                        <select name="is_published" id="is_published" class="form-control">
                            <option value="" {% if request.GET.is_published == "" %}selected{% endif %}>All</option>
                            <option value="yes" {% if request.GET.is_published == 'yes' %}selected{% endif %}>Yes</option>
                            <option value="no" {% if request.GET.is_published == 'no' %}selected{% endif %}>No</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary btn-block mt-4">Apply Filters</button>
                </div>
            </div>
        </form>
    </div>

    <div class="row">
        {% for project in projects %}
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{{ project.title }}</h5>
                    <p class="card-text">
                        <small class="text-muted">Created: {{ project.created_at|date:"F d, Y" }}</small>
                    </p>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="publishedCheck{{ project.id }}" {% if project.is_published %}checked{% endif %} onchange="updatePublishedStatus({{ project.id }}, this.checked)">
                        <label class="form-check-label" for="publishedCheck{{ project.id }}">Published on YouTube</label>
                    </div>
                    <div class="btn-group" role="group">
                        <a href="{% url 'edit_narration' project.id %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-edit btn-icon"></i>Edit
                        </a>
                        <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#youtubeDetailsModal{{ project.id }}">
                            <i class="fab fa-youtube btn-icon"></i>YouTube Details
                        </button>
                        {% if project.final_video %}
                        <a href="{{ project.final_video.url }}" class="btn btn-sm btn-success" download>
                            <i class="fas fa-download btn-icon"></i>Download Video
                        </a>
                        {% endif %}
                        {% if project.youtube_details.thumbnail %}
                        <a href="{{ project.youtube_details.thumbnail.url }}" class="btn btn-sm btn-warning" download>
                            <i class="fas fa-image btn-icon"></i>Download Thumbnail
                        </a>
                        {% else %}
                        <form action="{% url 'generate_thumbnail' project.id %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-secondary">
                                <i class="fas fa-image btn-icon"></i>Generate Thumbnail
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer">
                    <form action="{% url 'delete_project' project.id %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this project?')">
                            <i class="fas fa-trash btn-icon"></i>Delete
                        </button>
                    </form>
                    <form action="{% url 'regenerate_project' project.id %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-warning">
                            <i class="fas fa-sync btn-icon"></i>Regenerate
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- YouTube Details Modal -->
        <div class="modal fade" id="youtubeDetailsModal{{ project.id }}" tabindex="-1" role="dialog" aria-labelledby="youtubeDetailsModalLabel{{ project.id }}" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="youtubeDetailsModalLabel{{ project.id }}">YouTube Details for {{ project.title }}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        {% if project.youtube_details %}
                        <p><strong>Title:</strong> {{ project.youtube_details.title }}</p>
                        <p><strong>Description:</strong> {{ project.youtube_details.description }}</p>
                        <p><strong>Thumbnail Title:</strong> {{ project.youtube_details.thumbnail_title }}</p>
                        <p><strong>Thumbnail Prompt:</strong> {{ project.youtube_details.thumbnail_prompt }}</p>
                        {% else %}
                        <p>No YouTube details available for this project.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <p class="alert alert-info">No projects found. Create one to get started!</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    function updatePublishedStatus(projectId, isPublished) {
        fetch(`/update_published_status/${projectId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ is_published: isPublished })
        }).then(response => {
            if (!response.ok) {
                console.error('Failed to update published status');
            }
        });
    }
</script>
{% endblock %}
